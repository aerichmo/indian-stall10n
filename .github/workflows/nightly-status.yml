name: nightly-status
on:
  schedule:
    - cron: '*/30 * * * *'   # every 30 min UTC
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        ref: gh-pages
        fetch-depth: 1

    # ---------- GCP auth ----------
    - name: Auth to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: indianstall10n

    # ---------- Build snapshot ----------
    - name: Build status snapshot
      run: |
        set -euo pipefail
        NOW=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        gcloud functions list --format=json > functions.json
        gcloud run services list --format=json > run.json
        jq -n --arg now "$NOW" \
           --slurpfile f functions.json \
           --slurpfile r run.json \
           '{generated:$now, functions:$f[0], run:$r[0], dataflow:[], ai:[]}' \
           > status.json
        cp status.json status.html

    # ---------- Commit & push ----------
    - name: Commit snapshot
      run: |
        git config user.name  "github-actions"
        git config user.email "github-actions@users.noreply.github.com"
        git add status.json status.html
        git commit -m "auto: publish status snapshot $NOW" || echo "No changes"

    - name: Push to gh-pages
      uses: ad-m/github-push-action@v0.6.0
      with:
        branch: gh-pages
        force: true
