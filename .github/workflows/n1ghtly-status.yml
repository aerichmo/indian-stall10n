# .github/workflows/n1ghtly-status.yml
name: n1ghtly-status

# ────────────────
# 1. When to run
# ────────────────
on:
  schedule:          # UTC → 04:00 = 11 pm CDT / 09 pm PDT (adjust cron if needed)
    - cron:  '0 4 * * *'
  workflow_dispatch: # manual trigger button in the UI

# ────────────────
# 2. Global defaults
# ────────────────
defaults:
  run:
    shell: bash
    working-directory: ${{ github.workspace }}

env:
  GCLOUD_PROJECT: indianstall10n
  TZ: UTC

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
    # ---- 2.1 check out repo (required for gh-pages publishing) ----
    - uses: actions/checkout@v4

    # ---- 2.2 auth to Google Cloud with the service-account JSON key ----
    - id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # ---- 2.3 install the gcloud CLI ----
    - uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GCLOUD_PROJECT }}

    # ---- 2.4 pull resource inventories ----
    - name: List Cloud Functions → functions.json
      run: |
        gcloud functions list --format=json > functions.json

    - name: List Cloud Run services → run.json
      run: |
        gcloud run services list --format=json > run.json

    # add any other inventories you need.  If you don’t use them, keep empty arrays
    - name: Placeholder Dataflow, AI lists
      run: |
        echo '[]' > dataflow.json
        echo '[]' > ai.json

    # ---- 2.5 compose master status.json ----
    - name: Build status bundle
      run: |
        jq -n \
          --arg gen "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          --slurpfile f functions.json \
          --slurpfile r run.json \
          --slurpfile d dataflow.json \
          --slurpfile a ai.json \
          '{generated:$gen,functions:$f[0],run:$r[0],dataflow:$d[0],ai:$a[0]}' \
        > status.json

    # ---- 2.6 stage artefacts in a throw-away git repo ----
    - name: Stage artefacts
      run: |
        mkdir output
        mv status.json functions.json run.json dataflow.json ai.json output/
        cd output
        git init
        git config user.name  "github-actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "auto: publish status snapshot $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

    # ---- 2.7 publish output/ directory to gh-pages branch ----
    - name: Publish to gh-pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        deploy_key:  ${{ secrets.GH_PAGES_PUBLISHER_KEY }}
        publish_dir: output
        publish_branch: gh-pages
        commit_message: "status snapshot – ${{ github.run_id }}"

