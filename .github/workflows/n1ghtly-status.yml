name: status-publisher
on:
  schedule:
    # Runs at 02:15 UTC and 14:15 UTC daily (~9:15 AM / 9:15 PM CDT)
    - cron: "15 2,14 * * *"
  workflow_dispatch:

jobs:
  build-status:
    runs-on: ubuntu-latest
    permissions:          # scopes for the default GITHUB_TOKEN
      contents: write     # allow committing to gh-pages
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---- Authenticate to GCP ----
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: ">= 465.0.0"

      - name: Auth with workload identity key
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set default project
        run: gcloud config set project YOUR_PROJECT_ID   # <-- change

      # ---- Pull live data ----
      - name: Capture Cloud Functions list
        run: gcloud functions list --format=json > status/functions.json

      - name: Capture Pub/Sub topics list
        run: gcloud pubsub topics list --format=json > status/topics.json

      # (Optional) add any other gcloud queries you want:
      # gcloud logging read ... > status/logs.json

      # ---- Commit to gh-pages ----
      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./status          # folder created above
          publish_branch: gh-pages
          force_orphan: true             # keeps gh-pages separate
