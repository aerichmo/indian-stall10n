name: n1ghtly-status
on:
  schedule:
    # Twice daily – adjust to taste
    - cron:  '0 7 * * *'
    - cron:  '0 19 * * *'
  workflow_dispatch:

jobs:
  publish-status:
    runs-on: ubuntu-latest
    env:
      API_USER: ${{ secrets.API_USER }}
      API_PASS: ${{ secrets.API_PASS }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Build status.json
        shell: bash
        run: |
          node <<'EOF'
          const fs = require('fs');
          const https = require('https');
          const apiUser = process.env.API_USER;
          const apiPass = process.env.API_PASS;

          function callAPI() {
            return new Promise((resolve, reject) => {
              const req = https.request(
                {
                  hostname: 'example-racing-api.com',
                  path: '/status',
                  auth: `${apiUser}:${apiPass}`,
                  method: 'GET'
                },
                res => {
                  let data = '';
                  res.on('data', d => (data += d));
                  res.on('end', () => resolve(JSON.parse(data)));
                }
              );
              req.on('error', reject);
              req.end();
            });
          }

          (async () => {
            const payload = await callAPI();
            payload.generated = new Date().toISOString();
            fs.writeFileSync('status.json', JSON.stringify(payload, null, 2));
          })().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Commit & push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add status.json
          if git diff --cached --quiet; then
            echo "No changes – skip commit.";
          else
            git commit -m "chore: nightly status update [skip ci]"
            git push origin HEAD:gh-pages
          fi
