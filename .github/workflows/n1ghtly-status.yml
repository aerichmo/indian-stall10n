# .github/workflows/n1ghtly-status.yml
name: n1ghtly-status

################################################################################
# Triggers ────────────── run twice a day UTC-time + manual button
################################################################################
on:
  schedule:
    # 06:15 UTC  and  18:15 UTC  (≈ midnight / noon US-Central)
    - cron:  '15 6 * * *'
    - cron:  '15 18 * * *'
  workflow_dispatch:

################################################################################
# Default token gets CONTENTS-write so no PAT is required
################################################################################
permissions:
  contents: write          # push to gh-pages
  id-token: write          # (unused now, but handy if we add OIDC later)

################################################################################
# Job ───────────────────────────────────────────────────────────────────────────
################################################################################
jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout repo (full history so that force-push can replace it)
    - name: Checkout main
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2) ───────────── Generate / refresh status data
    #    Replace this stub with real logic whenever you’re ready.
    - name: Generate status.json
      run: |
        mkdir -p public                     # final output folder
        cat > public/status.json <<'EOF'
        {
          "generated": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
          "functions": [],
          "run": [],
          "dataflow": [],
          "ai": [],
          "note":  "placeholder file ­— add real status logic here"
        }
        EOF

    # 3) Commit the artefact back to *main* (optional but useful for history)
    - name: Commit artefact to main
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name  "github-actions[bot]"
        git add public/status.json
        git commit -m "chore: nightly status $(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          || echo "Nothing new to commit"

    # 4) ─────────────  Publish /public → gh-pages (force overwrite)
    - name: Push to gh-pages
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}   # no PAT needed
        branch: gh-pages
        directory: public
        force: true                                 # ALWAYS overwrite