name: n1ghtly-status   # nightly snapshot published to the gh-pages branch
on:
  workflow_dispatch:   # run by hand
  schedule:            # â€¦and automatically every night at 00:30 UTC
    - cron: '30 0 * * *'

jobs:
  snapshot:
    runs-on: ubuntu-latest

    env:
      GCLOUD_PROJECT: indianstall10n        # <-- hard-code or expose as a secret
      TZ: UTC                               # make sure timestamps are UTC

    steps:
    # 1. check out the repo
    - uses: actions/checkout@v4

    # 2. authenticate to Google Cloud with your **service-account JSON key**
    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id:   ${{ env.GCLOUD_PROJECT }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    # 3. pull the latest list of Cloud Functions for the project
    - name: Pull Cloud Functions list
      run: |
        gcloud functions list --format=json > functions.json

    # 4. wrap that list in a top-level object with a timestamp
    - name: Build status.json
      run: |
        TS=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        jq -n \
          --arg generated "$TS" \
          --slurpfile functions functions.json \
          '{generated:$generated, functions:$functions[0]}' \
          > status.json

    # 5. commit & push **only** the status.json file to the gh-pages branch
    #    using your dedicated deploy key (GH_PAGES_PUBLISHER_KEY)
    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.GH_PAGES_PUBLISHER_KEY }}

    - name: Commit and push
      run: |
        git config --global user.name  "gh-pages-publisher"
        git config --global user.email "actions@users.noreply.github.com"
        git fetch origin gh-pages       || git checkout --orphan gh-pages
        git switch gh-pages             || git checkout gh-pages
        mv status.json status.json      # overwrite / add at repo root
        git add status.json
        git commit -m "auto: publish status snapshot $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "Nothing new to commit"
        git push origin gh-pages
